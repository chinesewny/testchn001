<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <title>ChineseClass By Krukong</title>
  <link rel="icon" href="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
      body { 
          font-family: 'Sarabun', sans-serif; 
          background: radial-gradient(circle at top left, #1e3a8a, #0f172a, #000000); 
          background-attachment: fixed;
          color: #e2e8f0;
      }
      
      /* --- iOS Glassmorphism --- */
      .glass-ios {
          background: rgba(255, 255, 255, 0.07);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.15);
          box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }
      
      .glass-input {
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: white;
          transition: all 0.3s;
      }
      .glass-input:focus {
          background: rgba(0, 0, 0, 0.5);
          border-color: rgba(255, 255, 255, 0.3);
          outline: none;
      }

      /* Buttons & Status */
      .btn-blue { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border: 1px solid rgba(255,255,255,0.2); }
      .btn-blue:hover:not(:disabled) { box-shadow: 0 0 15px rgba(37, 99, 235, 0.5); transform: translateY(-1px); }
      
      .btn-red { background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: 1px solid rgba(255,255,255,0.2); }
      .btn-yellow { background: linear-gradient(135deg, #d97706, #b45309); color: white; border: 1px solid rgba(255,255,255,0.2); }

      /* ACTIVE STATES */
      .btn-score-active { 
          background: #eab308 !important; color: black !important; border: 2px solid #fff !important; 
          font-weight: bold; transform: scale(1.1); box-shadow: 0 0 15px rgba(234, 179, 8, 0.6);
      }

      .btn-att-active-present { background: #059669 !important; color: white !important; border-color: white !important; }
      .btn-att-active-leave { background: #d97706 !important; color: white !important; border-color: white !important; }
      .btn-att-active-absent { background: #dc2626 !important; color: white !important; border-color: white !important; }

      .status-box { transition: all 0.2s; border-radius: 12px; }
      .status-none { background: rgba(255, 255, 255, 0.05); border: 1px dashed rgba(255, 255, 255, 0.2); color: #94a3b8; }
      .status-done { background: rgba(5, 150, 105, 0.2); border: 1px solid #059669; color: #34d399; box-shadow: 0 0 10px rgba(5, 150, 105, 0.2); }
      
      .chapter-checkbox:checked + div { background: linear-gradient(135deg, #d97706, #b45309); color: white; border-color: white; }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
      ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

      #toast-notification { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s; }
      .toast-show { transform: translate(-50%, 0) !important; opacity: 1 !important; }

      /* PRINT STYLES */
      @media print {
        @page { size: A4 portrait; margin: 1cm; }
        body { background: white !important; color: black !important; -webkit-print-color-adjust: exact; }
        #app-root, #toast-notification, .no-print { display: none !important; }
        #print-area { display: block !important; position: relative !important; width: 100% !important; background: white !important; color: black !important; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        thead { display: table-header-group; } 
        tr { page-break-inside: avoid; page-break-after: auto; } /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ç‡∏≤‡∏î */
        th, td { border: 1px solid #000; padding: 6px; text-align: center; color: black; }
        .print-header-row td { border: none !important; padding-bottom: 10px; }
        .column-header th { background-color: #e5e7eb !important; color: black !important; font-weight: bold; border: 1px solid #000; }
      }
  </style>
 </head>
 <body class="w-full h-full min-h-screen">
  
  <div id="app-root" class="w-full h-full min-h-screen flex items-stretch justify-center p-2 md:p-4">
   <div class="w-full max-w-7xl rounded-3xl glass-ios flex flex-col relative overflow-hidden shadow-2xl">
    
    <header class="w-full px-6 py-4 border-b border-white/10 flex flex-col md:flex-row md:items-center md:justify-between gap-4 z-10 no-print">
     <div class="flex items-center gap-4">
      <div class="relative group">
          <div class="absolute -inset-1 bg-gradient-to-r from-red-600 via-yellow-500 to-blue-600 rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
          <img src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" alt="School Logo" class="relative h-16 w-16 object-contain bg-black/20 rounded-full p-1 border border-white/10">
      </div>
      <div>
        <h1 class="text-2xl font-bold text-white tracking-wide drop-shadow-md">Chinese<span class="text-yellow-400">Class</span> By Krukong</h1>
        <p class="text-blue-200 text-xs">‡∏Ñ‡∏£‡∏π‡∏Å‡∏µ‡∏£‡∏ï‡∏¥ ‡∏õ‡∏£‡∏∞‡∏™‡∏û‡∏û‡∏£‡∏£‡∏±‡∏á‡∏™‡∏µ - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</p>
      </div>
     </div>
     <nav class="inline-flex rounded-full bg-black/20 p-1 border border-white/5">
        <button id="tab-btn-admin" onclick="switchMainTab('admin')" class="px-6 py-2 rounded-full text-sm font-bold text-white/50 hover:text-white transition-all"><i class="fa-solid fa-chalkboard-user mr-2"></i>‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button> 
        <button id="tab-btn-student" onclick="switchMainTab('student')" class="px-6 py-2 rounded-full text-sm font-bold text-white/50 hover:text-white transition-all"><i class="fa-solid fa-user-graduate mr-2"></i>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
     </nav>
    </header>

    <main class="flex-1 w-full px-4 md:px-6 pb-6 overflow-y-auto no-print scroll-smooth">
     <div class="w-full max-w-7xl mx-auto mt-6 flex flex-col gap-6">
      
      <div id="section-admin" class="flex flex-col gap-5 hidden">
        
        <div id="admin-login-wrapper" class="flex flex-col items-center justify-center py-20 gap-8">
            <div class="glass-ios p-10 rounded-3xl w-full max-w-sm flex flex-col items-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-500 via-yellow-500 to-blue-500"></div>
                <img src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" alt="Logo" class="w-24 h-24 object-contain mb-6 drop-shadow-xl">
                <h2 class="text-2xl font-bold text-white mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
                <form id="admin-login-form" class="space-y-4 w-full">
                    <input id="admin-username" type="text" placeholder="Username" class="w-full rounded-xl glass-input px-4 py-3 text-white placeholder-white/30 text-center">
                    <input id="admin-password" type="password" placeholder="Password" class="w-full rounded-xl glass-input px-4 py-3 text-white placeholder-white/30 text-center">
                    <button type="submit" class="w-full py-3 rounded-xl btn-yellow font-bold shadow-lg text-lg mt-2">Login</button>
                </form>
            </div>
        </div>

        <div id="admin-content-wrapper" class="hidden flex flex-col gap-6">
            <div class="flex justify-between items-center glass-ios px-4 py-3 rounded-2xl">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-lg text-white font-bold shadow-lg ring-2 ring-white/20"><i class="fa-solid fa-user-tie"></i></div>
                    <div><h3 class="text-sm font-bold text-white">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3><p class="text-[10px] text-green-400 font-bold"><i class="fa-solid fa-circle text-[8px] mr-1"></i>Online</p></div>
                </div>
                <button onclick="handleAdminLogout()" class="bg-white/10 hover:bg-red-500/80 text-white px-4 py-2 rounded-xl text-xs font-bold transition-all border border-white/10"><i class="fa-solid fa-power-off mr-2"></i>‡∏≠‡∏≠‡∏Å</button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                <button onclick="switchAdminSubTab('basic')" id="menu-basic" class="menu-btn btn-blue rounded-2xl py-3 font-bold shadow-lg"><i class="fa-solid fa-folder-open block text-xl mb-1"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button> 
                <button onclick="switchAdminSubTab('scan')" id="menu-scan" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"><i class="fa-solid fa-qrcode block text-xl mb-1"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                <button onclick="switchAdminSubTab('report')" id="menu-report" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"><i class="fa-solid fa-print block text-xl mb-1"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå/CSV</button>
                 <button onclick="switchAdminSubTab('homework')" id="menu-homework" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold relative"><i class="fa-solid fa-list-check block text-xl mb-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô<span id="badge-homework" class="absolute top-2 right-2 bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded-full hidden">0</span></button>
                 <button onclick="switchAdminSubTab('attendance')" id="menu-attendance" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"><i class="fa-solid fa-user-check block text-xl mb-1"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                <button onclick="switchAdminSubTab('material')" id="menu-material" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"><i class="fa-solid fa-book-open block text-xl mb-1"></i> ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</button>
            </div>

            <section id="admin-panel-basic" class="admin-panel hidden glass-ios rounded-3xl p-6">
               <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="bg-white/5 p-5 rounded-2xl border border-white/10 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-yellow-500"></div>
                    <h4 class="text-sm font-bold text-white mb-4 uppercase tracking-wider">1. ‡∏ß‡∏¥‡∏ä‡∏≤ & ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                    <form id="form-subject" class="flex gap-2 mb-4"><input id="subject-name" class="flex-1 glass-input rounded-lg px-3 py-2 text-xs" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤"><button type="submit" class="btn-yellow px-4 py-2 rounded-lg text-xs font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button></form>
                    <form id="form-class" class="flex gap-2 pt-4 border-t border-white/10"><input id="class-name" class="flex-1 glass-input rounded-lg px-3 py-2 text-xs" placeholder="‡∏´‡πâ‡∏≠‡∏á"><select id="class-subject-ref" class="w-1/3 glass-input rounded-lg px-2 py-2 text-xs"></select><button type="submit" class="btn-yellow px-4 py-2 rounded-lg text-xs font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button></form>
                 </div>
                 <div class="bg-white/5 p-5 rounded-2xl border border-white/10 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                    <h4 class="text-sm font-bold text-white mb-4 uppercase tracking-wider">2. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                    <form id="form-student" class="space-y-3">
                        <div class="grid grid-cols-12 gap-2">
                            <div class="col-span-5"><select id="student-class" class="w-full glass-input rounded-lg px-2 py-2 text-sm"></select></div>
                            <div class="col-span-3"><input id="student-no" type="number" class="w-full glass-input rounded-lg px-2 py-2 text-sm text-center" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"></div>
                            <div class="col-span-4"><input id="student-id" class="w-full glass-input rounded-lg px-2 py-2 text-sm" placeholder="ID"></div>
                        </div>
                        <div><input id="student-name" class="w-full glass-input rounded-lg px-3 py-2 text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
                        <button type="submit" class="w-full btn-blue py-2 rounded-lg text-sm font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </form>
                 </div>
               </div>
               
               <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                   <div class="bg-white/5 p-5 rounded-2xl border border-white/10 relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                         <h4 class="text-sm font-bold text-white mb-4 uppercase tracking-wider">3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Multi-Chapter)</h4>
                         <form id="form-task" class="space-y-3">
                            <div><label class="text-[10px] text-white/50">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</label><select id="task-subject-filter" class="w-full glass-input rounded-lg px-2 py-2 text-xs" onchange="renderTaskClassCheckboxes()"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option></select></div>
                            <div><label class="text-[10px] text-white/50">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label><div id="task-class-checkboxes" class="grid grid-cols-3 gap-2 bg-black/20 border border-white/5 rounded-lg p-2 max-h-24 overflow-y-auto"></div></div>
                             <div class="grid grid-cols-2 gap-3">
                                 <div><label class="text-[10px] text-white/50">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="task-category" class="w-full glass-input rounded-lg px-2 py-2 text-xs font-bold text-yellow-400"><option value="accum">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö (60)</option><option value="midterm">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (20)</option><option value="final">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (30)</option><option value="special">‡∏û‡∏¥‡πÄ‡∏®‡∏©</option></select></div>
                                 <div id="chapter-wrapper">
                                     <label class="text-[10px] text-white/50">‡∏ö‡∏ó‡∏ó‡∏µ‡πà</label>
                                     <div class="flex gap-2">
                                         <label class="cursor-pointer relative"><input type="checkbox" name="task_chap" value="1" class="chapter-checkbox sr-only"><div class="w-8 h-8 rounded-lg bg-black/30 border border-white/10 flex items-center justify-center text-xs font-bold text-white/50 hover:bg-white/10 transition-all">1</div></label>
                                         <label class="cursor-pointer relative"><input type="checkbox" name="task_chap" value="2" class="chapter-checkbox sr-only"><div class="w-8 h-8 rounded-lg bg-black/30 border border-white/10 flex items-center justify-center text-xs font-bold text-white/50 hover:bg-white/10 transition-all">2</div></label>
                                         <label class="cursor-pointer relative"><input type="checkbox" name="task_chap" value="3" class="chapter-checkbox sr-only"><div class="w-8 h-8 rounded-lg bg-black/30 border border-white/10 flex items-center justify-center text-xs font-bold text-white/50 hover:bg-white/10 transition-all">3</div></label>
                                         <label class="cursor-pointer relative"><input type="checkbox" name="task_chap" value="4" class="chapter-checkbox sr-only"><div class="w-8 h-8 rounded-lg bg-black/30 border border-white/10 flex items-center justify-center text-xs font-bold text-white/50 hover:bg-white/10 transition-all">4</div></label>
                                         <label class="cursor-pointer relative"><input type="checkbox" name="task_chap" value="5" class="chapter-checkbox sr-only"><div class="w-8 h-8 rounded-lg bg-black/30 border border-white/10 flex items-center justify-center text-xs font-bold text-white/50 hover:bg-white/10 transition-all">5</div></label>
                                         <label class="cursor-pointer relative"><input type="checkbox" name="task_chap" value="6" class="chapter-checkbox sr-only"><div class="w-8 h-8 rounded-lg bg-black/30 border border-white/10 flex items-center justify-center text-xs font-bold text-white/50 hover:bg-white/10 transition-all">6</div></label>
                                     </div>
                                 </div>
                             </div>
                             <div class="grid grid-cols-12 gap-2"><div class="col-span-8"><input id="task-name" class="w-full glass-input rounded-lg px-3 py-2 text-xs" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô"></div><div class="col-span-4"><input id="task-max" type="number" class="w-full glass-input rounded-lg px-2 py-2 text-xs text-center" value="10" placeholder="Max"></div></div>
                             <button type="submit" class="w-full btn-red py-2 rounded-lg text-sm font-bold shadow-lg">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
                         </form>
                   </div>
                   
                   <div class="bg-white/5 p-5 rounded-2xl border border-white/10 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                        <h4 class="text-sm font-bold text-white mb-4 uppercase tracking-wider">4. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô (Timetable)</h4>
                        <form id="form-schedule" class="space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <select id="sch-day" class="glass-input rounded-lg px-2 py-2 text-xs">
                                    <option value="1">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option><option value="2">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option><option value="3">‡∏û‡∏∏‡∏ò</option><option value="4">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option><option value="5">‡∏®‡∏∏‡∏Å‡∏£‡πå</option><option value="6">‡πÄ‡∏™‡∏≤‡∏£‡πå</option><option value="0">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
                                </select>
                                <select id="sch-period" class="glass-input rounded-lg px-2 py-2 text-xs">
                                    <option value="1">‡∏Ñ‡∏≤‡∏ö 1 (08:30)</option><option value="2">‡∏Ñ‡∏≤‡∏ö 2 (09:20)</option><option value="3">‡∏Ñ‡∏≤‡∏ö 3 (10:10)</option><option value="4">‡∏Ñ‡∏≤‡∏ö 4 (11:00)</option>
                                    <option value="5">‡∏Ñ‡∏≤‡∏ö 5 (11:50)</option><option value="6">‡∏Ñ‡∏≤‡∏ö 6 (12:40)</option><option value="7">‡∏Ñ‡∏≤‡∏ö 7 (13:30)</option><option value="8">‡∏Ñ‡∏≤‡∏ö 8 (14:20)</option>
                                </select>
                            </div>
                            <select id="sch-class" class="w-full glass-input rounded-lg px-2 py-2 text-xs"></select>
                            <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2 rounded-lg text-sm font-bold shadow-lg hover:from-purple-500 hover:to-pink-500 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
                        </form>
                        <div id="schedule-list" class="mt-4 max-h-40 overflow-y-auto space-y-2 pr-1"></div>
                   </div>
               </div>
            </section>
            
            <section id="admin-panel-attendance" class="admin-panel hidden glass-ios rounded-3xl p-6 flex flex-col gap-6">
                <div id="smart-att-banner" class="hidden bg-gradient-to-r from-blue-900/50 to-blue-600/50 border border-blue-400/30 rounded-2xl p-4 flex items-center justify-between shadow-lg backdrop-blur-md">
                    <div class="flex items-center gap-4">
                        <div class="h-12 w-12 rounded-full bg-white/20 flex items-center justify-center text-2xl animate-pulse"><i class="fa-solid fa-bell"></i></div>
                        <div>
                            <h3 class="font-bold text-white text-lg">‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</h3>
                            <p class="text-blue-200 text-sm">‡∏Ñ‡∏≤‡∏ö <span id="smart-period" class="font-bold text-white"></span> : ‡∏´‡πâ‡∏≠‡∏á <span id="smart-class-name" class="font-bold text-amber-400 text-lg"></span></p>
                        </div>
                    </div>
                    <button onclick="useSmartClass()" class="btn-yellow px-6 py-2 rounded-xl font-bold shadow-lg">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 min-h-[500px]">
                    <div class="lg:col-span-1 bg-white/5 p-5 rounded-2xl border border-white/10 flex flex-col gap-5">
                        <h3 class="font-bold text-white text-lg border-b border-white/10 pb-2">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° & ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
                        
                        <div class="bg-black/30 p-3 rounded-xl mb-2">
                            <label class="text-xs text-white/50 mb-1 block">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <input id="att-date-input" type="date" class="w-full glass-input rounded-xl px-3 py-2 text-sm font-mono text-center mb-2">
                            <select id="att-class-select" class="w-full glass-input rounded-xl px-3 py-2 text-sm mb-2 mt-1"></select>
                            
                            <div id="att-stats" class="text-center py-2 border-t border-white/10 mt-2">
                                <p class="text-xs text-white/50">‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</p>
                                <div class="grid grid-cols-3 gap-1 mt-1 text-sm font-bold">
                                    <div class="text-green-400"><i class="fa-solid fa-check"></i> <span id="stat-present">0</span></div>
                                    <div class="text-yellow-400"><i class="fa-solid fa-envelope"></i> <span id="stat-leave">0</span></div>
                                    <div class="text-red-400"><i class="fa-solid fa-xmark"></i> <span id="stat-absent">0</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="text-xs text-white/50 block mb-1">üì∑ ‡πÇ‡∏´‡∏°‡∏î‡∏™‡πÅ‡∏Å‡∏ô (‡∏ï‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</label>
                            <input id="att-scan-input" type="text" class="w-full glass-input rounded-xl px-4 py-3 text-lg text-center font-bold text-yellow-400 focus:border-yellow-500 outline-none placeholder-white/20" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î..." autocomplete="off">
                        </div>
                        <div class="space-y-3">
                            <button onclick="setAttMode('‡∏°‡∏≤')" id="btn-att-present" class="w-full py-3 rounded-xl border border-green-500/50 bg-green-500/10 text-green-400 font-bold flex justify-between px-4 transition-all"><span>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span> <i class="fa-solid fa-check"></i></button>
                            <button onclick="setAttMode('‡∏•‡∏≤')" id="btn-att-leave" class="w-full py-3 rounded-xl border border-yellow-500/50 bg-yellow-500/10 text-yellow-400 font-bold flex justify-between px-4 transition-all"><span>‡∏•‡∏≤</span> <i class="fa-solid fa-envelope"></i></button>
                            <button onclick="setAttMode('‡∏Ç‡∏≤‡∏î')" id="btn-att-absent" class="w-full py-3 rounded-xl border border-red-500/50 bg-red-500/10 text-red-400 font-bold flex justify-between px-4 transition-all"><span>‡∏Ç‡∏≤‡∏î</span> <i class="fa-solid fa-xmark"></i></button>
                        </div>
                        
                        <div class="mt-auto pt-4 border-t border-white/10">
                            <button onclick="exportAttendanceCSV()" class="w-full py-3 rounded-xl bg-gradient-to-r from-teal-600 to-green-600 text-white font-bold shadow-lg hover:from-teal-500 hover:to-green-500"><i class="fa-solid fa-file-csv mr-2"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (CSV)</button>
                        </div>
                    </div>
                    <div class="lg:col-span-3 bg-black/20 p-5 rounded-2xl border border-white/10 flex flex-col">
                        <div id="att-roster-grid" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-5 gap-3 overflow-y-auto max-h-[600px] p-1"></div>
                    </div>
                </div>
            </section>
            
            <section id="admin-panel-scan" class="admin-panel hidden glass-ios rounded-3xl p-6 flex flex-col gap-6">
                 <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 min-h-[500px]">
                     <div class="lg:col-span-1 bg-white/5 p-5 rounded-2xl border border-white/10 flex flex-col gap-5">
                         <h3 class="font-bold text-white text-lg border-b border-white/10 pb-2">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                         <div><label class="text-xs text-white/50">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á/‡∏á‡∏≤‡∏ô</label><select id="scan-class-select" class="w-full glass-input rounded-xl px-3 py-2 text-xs mb-2"></select><select id="scan-task-select" class="w-full glass-input rounded-xl px-3 py-2 text-xs font-bold text-yellow-400"></select></div>
                         <div class="bg-black/20 p-3 rounded-xl border border-white/5 flex flex-col gap-2"><label class="text-xs text-white/50">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label><div id="score-buttons-container" class="grid grid-cols-5 gap-1"></div><button onclick="setScoreMode('manual')" id="btn-score-manual" class="w-full py-2 rounded-lg border border-white/20 bg-white/5 text-white/70 text-xs font-bold hover:bg-white/10">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á</button></div>
                         <div><label class="text-xs text-white/50 block mb-2">3. ‡∏™‡πÅ‡∏Å‡∏ô/‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™</label><input id="scan-score-input" type="text" class="w-full glass-input rounded-xl px-4 py-3 text-lg text-center font-bold focus:border-yellow-500 outline-none placeholder-white/20" placeholder="Scan here..."></div>
                     </div>
                     <div class="lg:col-span-3 bg-black/20 p-5 rounded-2xl border border-white/10 flex flex-col">
                         <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-white/80">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><span class="text-xs text-green-400 animate-pulse"><i class="fa-solid fa-wifi"></i> Syncing</span></div>
                         <div id="score-roster-grid" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-5 gap-3 overflow-y-auto max-h-[600px] p-1"></div>
                     </div>
                 </div>
            </section>

            <section id="admin-panel-report" class="admin-panel hidden glass-ios rounded-3xl p-6 flex flex-col gap-6">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <h3 class="text-xl font-bold text-white">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div class="flex gap-3">
                        <button onclick="printOfficialReport()" class="btn-blue px-6 py-2.5 rounded-xl text-sm font-bold flex gap-2 shadow-lg items-center">
                            <i class="fa-solid fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå PDF
                        </button>
                        <button onclick="exportGradeCSV()" class="btn-yellow px-6 py-2.5 rounded-xl text-sm font-bold flex gap-2 shadow-lg items-center">
                            <i class="fa-solid fa-file-csv"></i> ‡πÇ‡∏´‡∏•‡∏î CSV
                        </button>
                    </div>
                </div>
                
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="text-xs text-white/50 block mb-1">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</label>
                        <select id="report-subject" class="w-full glass-input rounded-xl px-4 py-2 text-sm"></select>
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-white/50 block mb-1">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <select id="report-class" class="w-full glass-input rounded-xl px-4 py-2 text-sm">
                            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô --</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto bg-black/20 rounded-2xl border border-white/10">
                    <table class="min-w-full text-sm text-white/80">
                        <thead class="bg-white/5 text-xs uppercase font-semibold text-white/60">
                            <tr>
                                <th class="px-2 py-4 text-center">#</th>
                                <th class="px-2 py-4 text-left min-w-[150px]">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="px-1 py-4 text-center text-yellow-400">‡∏ö‡∏ó1</th>
                                <th class="px-1 py-4 text-center text-yellow-400">‡∏ö‡∏ó2</th>
                                <th class="px-1 py-4 text-center text-yellow-400">‡∏ö‡∏ó3</th>
                                <th class="px-1 py-4 text-center text-yellow-400">‡∏ö‡∏ó4</th>
                                <th class="px-1 py-4 text-center text-yellow-400">‡∏ö‡∏ó5</th>
                                <th class="px-1 py-4 text-center text-yellow-400">‡∏ö‡∏ó6</th>
                                <th class="px-1 py-4 text-center text-blue-400">‡∏Å‡∏•‡∏≤‡∏á</th>
                                <th class="px-1 py-4 text-center text-red-400">‡∏õ‡∏•‡∏≤‡∏¢</th>
                                <th class="px-2 py-4 text-center text-white font-bold bg-white/10">‡∏£‡∏ß‡∏°</th>
                                <th class="px-2 py-4 text-center">‡πÄ‡∏Å‡∏£‡∏î</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </section>
            
             <section id="admin-panel-homework" class="admin-panel hidden glass-ios rounded-3xl p-6"><div id="incoming-list" class="grid grid-cols-1 gap-4"></div></section>
             <section id="admin-panel-material" class="admin-panel hidden glass-ios rounded-3xl p-6 flex flex-col gap-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 bg-white/5 p-5 rounded-2xl border border-white/10 h-fit"><h3 class="font-bold text-white mb-4 border-b border-white/10 pb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</h3><form id="form-material" class="space-y-4"><div><label class="text-xs text-white/50">‡∏ß‡∏¥‡∏ä‡∏≤</label><select id="mat-subject" class="w-full glass-input rounded-xl px-3 py-2 text-sm" required></select></div><div><label class="text-xs text-white/50">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label><input id="mat-title" type="text" class="w-full glass-input rounded-xl px-3 py-2 text-sm" required></div><div><label class="text-xs text-white/50">‡∏•‡∏¥‡∏á‡∏Å‡πå</label><input id="mat-link" type="url" class="w-full glass-input rounded-xl px-3 py-2 text-blue-300 text-sm" placeholder="https://..." required></div><button type="submit" class="w-full btn-yellow py-2 rounded-xl font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></form></div><div class="md:col-span-2 flex flex-col gap-4"><div id="admin-mat-list" class="grid grid-cols-1 gap-3 overflow-y-auto max-h-[600px] pr-2"></div></div></div></section>

        </div>
      </div>

      <div id="section-student" class="hidden flex flex-col gap-5">
         <div id="student-login-wrapper" class="flex flex-col items-center justify-center py-20 gap-8">
            <div class="glass-ios p-10 rounded-3xl w-full max-w-sm flex flex-col items-center relative">
                <img src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" alt="Logo" class="w-24 h-24 object-contain mb-6 drop-shadow-lg">
                <h2 class="text-2xl font-bold text-white mb-6">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <input id="student-login-id" type="text" class="w-full glass-input rounded-xl px-4 py-3 text-center text-white text-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                <button onclick="handleStudentLogin()" class="w-full py-3 rounded-xl btn-blue font-bold shadow-lg mt-4 text-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
        <div id="student-dashboard" class="hidden flex flex-col gap-6">
             <div class="glass-ios p-6 rounded-3xl flex items-center justify-between">
                 <div><h2 id="std-dash-name" class="text-2xl font-bold text-white">-</h2><span id="std-dash-class" class="text-blue-300 font-bold text-sm">-</span></div>
                 <button onclick="logoutStudent()" class="text-white/50 hover:text-red-400 text-xl"><i class="fa-solid fa-right-from-bracket"></i></button>
             </div>
             
             <div id="std-subjects-container" class="flex flex-col gap-6"></div>
             
             <div class="glass-ios p-5 rounded-3xl border border-white/10">
                 <h3 class="font-bold text-white mb-4 border-b border-white/10 pb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤)</h3>
                 <div class="overflow-y-auto max-h-60">
                     <table class="w-full text-sm text-left text-white/80">
                         <thead class="text-xs uppercase bg-white/5 text-white/50"><tr><th class="px-3 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-3 py-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                         <tbody id="std-att-body" class="divide-y divide-white/5"></tbody>
                     </table>
                 </div>
             </div>
        </div>
      </div>

     </div>
    </main>
    
    <div id="score-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md">
        <div class="glass-ios p-8 rounded-3xl w-full max-w-xs shadow-2xl transform scale-100 transition-all">
            <h3 class="text-lg font-bold text-white mb-2 text-center">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
            <p class="text-white/60 text-sm mb-1 text-center" id="modal-task-name"></p>
            <p class="text-yellow-400 text-xl font-bold mb-6 text-center" id="modal-student-name"></p>
            <div class="relative mb-6"><input id="modal-score-input" type="number" class="w-full bg-black/40 border-2 border-yellow-500 rounded-2xl px-4 py-4 text-4xl text-center text-white font-bold focus:outline-none"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-white/40 text-sm">/ <span id="modal-max-score"></span></span></div>
            <div class="grid grid-cols-2 gap-3"><button onclick="closeScoreModal()" class="py-3 rounded-xl bg-white/10 text-white font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button id="btn-modal-save" class="py-3 rounded-xl btn-blue font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
    </div>
    
    <div id="submit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md">
        <div class="glass-ios border border-white/10 rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-2"><i class="fa-solid fa-paper-plane mr-2 text-blue-400"></i>‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h3>
            <p class="text-sm text-white/50 mb-4" id="submit-modal-title"></p>
            <form id="form-submit-work" class="space-y-4">
                <input type="hidden" id="submit-task-id">
                <input type="hidden" id="submit-student-id">
                
                <div>
                    <label class="text-xs text-white/50 mb-1 block">1. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô (Google Drive, YouTube, PDF)</label>
                    <input id="submit-link-input" type="url" class="w-full glass-input rounded-xl px-3 py-2 text-white text-sm focus:border-blue-500 outline-none" placeholder="https://..." required>
                </div>

                <div>
                    <label class="text-xs text-white/50 mb-1 block">2. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏£‡∏π (‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</label>
                    <textarea id="submit-comment-input" class="w-full glass-input rounded-xl px-3 py-2 text-white text-sm h-16 resize-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å, ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏°‡∏≤..."></textarea>
                </div>

                <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                    <label class="text-xs text-yellow-400 mb-2 block font-bold"><i class="fa-solid fa-users mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                    <input type="text" id="friend-search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô..." class="w-full glass-input rounded-lg px-2 py-1 text-xs mb-2">
                    <div id="friend-selector-container" class="max-h-48 overflow-y-auto grid grid-cols-1 gap-2 pr-1"></div>
                </div>

                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="document.getElementById('submit-modal').classList.add('hidden')" class="px-4 py-2 rounded-xl bg-white/10 text-white/70 text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" id="btn-submit-final" class="px-4 py-2 rounded-xl btn-blue text-white text-sm font-bold shadow-lg">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="toast-notification" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gradient-to-r from-green-600 to-teal-600 text-white px-8 py-4 rounded-full shadow-2xl z-50 flex items-center gap-3 translate-y-20 opacity-0 font-bold border border-green-400/50"><i class="fa-solid fa-circle-check text-2xl"></i><span id="toast-message" class="text-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span></div>
   </div>
  </div>

  <div id="print-area" class="hidden">
      <table id="print-table" style="width: 100%;">
          <thead>
              <tr class="print-header-row">
                  <td colspan="13" style="text-align:center; border: none; padding-bottom: 10px;">
                      <img src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" style="width: 70px; height: auto; margin-bottom: 5px; margin-top: 10px; display: inline-block;">
                      <h2 style="font-size: 18px; font-weight: bold; margin: 0; line-height: 1.2;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏™‡∏±‡∏°‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                      <h3 style="font-size: 16px; margin: 0; line-height: 1.2;">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô (ChineseClass System)</h3>
                      <p id="print-subtitle" style="font-size: 14px; margin-top: 5px;">‡∏ä‡∏±‡πâ‡∏ô‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà ... ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ... ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ...</p>
                  </td>
              </tr>
              <tr class="column-header">
                  <th style="width: 5%;">‡∏ó‡∏µ‡πà</th>
                  <th style="width: 10%;">‡∏£‡∏´‡∏±‡∏™</th>
                  <th style="width: 25%;">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th>‡∏ö‡∏ó 1</th><th>‡∏ö‡∏ó 2</th><th>‡∏ö‡∏ó 3</th><th>‡∏ö‡∏ó 4</th><th>‡∏ö‡∏ó 5</th><th>‡∏ö‡∏ó 6</th>
                  <th>‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ</th><th>‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ</th><th>‡∏£‡∏ß‡∏°</th><th>‡πÄ‡∏Å‡∏£‡∏î</th>
              </tr>
          </thead>
          <tbody id="print-table-body"></tbody>
      </table>
      <div style="margin-top: 30px; display: flex; justify-content: space-between; font-size: 14px; page-break-inside: avoid;">
          <div style="text-align: center; width: 40%;"><p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ...........................................................</p><p>( ........................................................... )</p><p>‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤</p></div>
          <div style="text-align: center; width: 40%;"><p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ...........................................................</p><p>( ........................................................... )</p><p>‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø</p></div>
      </div>
  </div>

 <script>
    // ***********************************************
    // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà Deploy ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQNjMSE06u5xO4dtyipa5P-YzoaicppubdwlUgMpaX4L4TUjk3-xY2PRnzhS42AxZe/exec"; 
    // ***********************************************

    let dataState = { subjects:[], classes:[], students:[], tasks:[], scores:[], attendance:[], materials:[], submissions:[], returns:[], schedules:[] };
    let scoreMode = 'manual'; 
    let attMode = null;
    let pendingScore = null;
    let smartClassId = null; 

    const PERIODS = [
        { p: 1, start: "08:30", end: "09:20" },
        { p: 2, start: "09:20", end: "10:10" },
        { p: 3, start: "10:10", end: "11:00" },
        { p: 4, start: "11:00", end: "11:50" },
        { p: 5, start: "11:50", end: "12:40" },
        { p: 6, start: "12:40", end: "13:30" },
        { p: 7, start: "13:30", end: "14:20" },
        { p: 8, start: "14:20", end: "15:10" }
    ];

    window.addEventListener('DOMContentLoaded', () => {
        if(document.getElementById('att-date-input')) document.getElementById('att-date-input').value = getThaiDateISO();
        renderScoreButtons();
        initEventListeners();
        loadFromLocalStorage();

        const savedSession = localStorage.getItem('wany_admin_session');
        if(savedSession) { showAdminPanel(true); } 
        else { switchMainTab('student'); syncData(); }
        
        setInterval(checkSmartSchedule, 60000);
    });

    async function syncData() {
        try {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData&t=${new Date().getTime()}`);
            const json = await res.json();
            if(json) { 
                dataState = json; 
                if(!dataState.schedules) dataState.schedules = [];
                if(!dataState.submissions) dataState.submissions = [];
                if(!dataState.returns) dataState.returns = [];
                refreshUI(); 
                saveToLocalStorage(); 
                const statusIcon = document.getElementById('student-dashboard').classList.contains('hidden') ? '' : ' (Student Online)';
            }
        } catch(e) { console.error(e); showToast("Offline Mode", "bg-yellow-600"); }
    }

    function saveToLocalStorage() { localStorage.setItem('wany_data_backup', JSON.stringify({ timestamp: new Date().getTime(), data: dataState })); }
    function loadFromLocalStorage() { 
        const b = localStorage.getItem('wany_data_backup'); 
        if(b) { const p = JSON.parse(b); if(new Date().getTime() - p.timestamp < 7200000) dataState = p.data; } 
    }

    function showAdminPanel(auto=false) { 
        document.getElementById('admin-login-wrapper').classList.add('hidden'); 
        document.getElementById('admin-content-wrapper').classList.remove('hidden'); 
        refreshUI(); 
        if(!auto) syncData(); 
    }

    function refreshUI() {
        refreshDropdowns();
        renderScheduleList();
        checkSmartSchedule(); 
        if(!document.getElementById('admin-panel-scan').classList.contains('hidden')) { updateScanTaskDropdown(); renderScoreRoster(); }
        if(!document.getElementById('admin-panel-report').classList.contains('hidden')) { renderGradeReport(); }
        if(!document.getElementById('admin-panel-homework').classList.contains('hidden')) { renderIncomingSubmissions(); }
        if(!document.getElementById('admin-panel-attendance').classList.contains('hidden')) { renderAttRoster(); }
        if(!document.getElementById('admin-panel-material').classList.contains('hidden')) { renderAdminMaterials(); }
        updateInboxBadge();
    }

    async function saveAndRefresh(payload) {
        updateLocalState(payload); refreshUI();
        try { const res = await fetch(GOOGLE_SCRIPT_URL, { method:'POST', body:JSON.stringify(payload) }); if(payload.action==='login') return await res.json(); } 
        catch(e) { showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ô‡πá‡∏ï)", "bg-red-600"); }
    }

    function updateLocalState(p) {
        if(p.action === 'addSubject') dataState.subjects.push({id:p.id, name:p.name});
        if(p.action === 'addClass') dataState.classes.push({id:p.id, name:p.name, subjectId:p.subjectId});
        if(p.action === 'addStudent') dataState.students.push({id:p.id, classId:p.classId, no:p.no, code:p.code, name:p.name});
        if(p.action === 'addTask') {
                p.classIds.forEach((cid, idx) => {
                    const chapStr = Array.isArray(p.chapter) ? p.chapter.join(',') : p.chapter;
                    dataState.tasks.push({ id: Number(p.id) + idx, classId: cid, subjectId: p.subjectId, category: p.category, chapter: chapStr, name: p.name, maxScore: p.maxScore, dueDateISO: p.dueDateISO });
                });
        }
        if(p.action === 'addScore') {
            const idx = dataState.scores.findIndex(s => s.studentId == p.studentId && s.taskId == p.taskId);
            if(idx >= 0) dataState.scores[idx].score = p.score; else dataState.scores.push({studentId:p.studentId, taskId:p.taskId, score:p.score});
            // Clear return status if score added
            if(dataState.returns) dataState.returns = dataState.returns.filter(r => !(r.studentId == p.studentId && r.taskId == p.taskId));
        }
        if(p.action === 'addAttendance') {
            const idx = dataState.attendance.findIndex(a => a.studentId == p.studentId && a.date == p.date);
            if(idx >= 0) dataState.attendance[idx].status = p.status; else dataState.attendance.push({studentId:p.studentId, classId:p.classId, date:p.date, status:p.status});
        }
        if(p.action === 'addMaterial') dataState.materials.push({id:p.id, subjectId:p.subjectId, title:p.title, link:p.link, type:p.type});
        if(p.action === 'addSchedule') dataState.schedules.push({ id:p.id, day:p.day, period:p.period, classId:p.classId });
        if(p.action === 'returnForRevision') {
             dataState.submissions = dataState.submissions.filter(s => !(s.studentId == p.studentId && s.taskId == p.taskId));
             if(!dataState.returns) dataState.returns = [];
             dataState.returns.push({taskId:p.taskId, studentId:p.studentId, comment:p.comment, timestampISO: new Date().toISOString()});
        }
        if(p.action === 'submitTask') {
            p.studentIds.forEach(sid => {
                 // Remove old submission & return
                 dataState.submissions = dataState.submissions.filter(s => !(s.studentId == sid && s.taskId == p.taskId));
                 if(dataState.returns) dataState.returns = dataState.returns.filter(r => !(r.studentId == sid && r.taskId == p.taskId));
                 
                 dataState.submissions.push({taskId:p.taskId, studentId:sid, link:p.link, timestampISO: new Date().toISOString(), comment: p.comment});
            });
        }
    }

    function checkSmartSchedule() {
        if(!dataState.schedules) return;
        const now = new Date();
        const day = now.getDay();
        const timeStr = now.toTimeString().slice(0,5); 
        let currentPeriod = PERIODS.find(p => timeStr >= p.start && timeStr <= p.end);
        const banner = document.getElementById('smart-att-banner');

        if(currentPeriod && dataState.schedules) {
            const match = dataState.schedules.find(s => s.day == day && s.period == currentPeriod.p);
            if(match) {
                const cls = dataState.classes.find(c => c.id == match.classId);
                if(cls) {
                    banner.classList.remove('hidden');
                    document.getElementById('smart-period').textContent = currentPeriod.p;
                    document.getElementById('smart-class-name').textContent = cls.name;
                    smartClassId = cls.id;
                    return;
                }
            }
        }
        banner.classList.add('hidden');
        smartClassId = null;
    }

    window.useSmartClass = function() {
        if(smartClassId) {
            document.getElementById('att-class-select').value = smartClassId;
            renderAttRoster();
        }
    }

    function renderScheduleList() {
        const div = document.getElementById('schedule-list');
        div.innerHTML = '';
        if(!dataState.schedules) return;
        const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'];
        const sorted = [...dataState.schedules].sort((a,b) => (a.day - b.day) || (a.period - b.period));
        sorted.forEach(s => {
            const clsName = dataState.classes.find(c=>c.id==s.classId)?.name || '?';
            const row = document.createElement('div');
            row.className = "flex justify-between items-center text-xs text-white/70 bg-white/5 p-2 rounded border border-white/5";
            row.innerHTML = `<span>${days[s.day]} ‡∏Ñ‡∏≤‡∏ö ${s.period}</span> <span class="text-yellow-400 font-bold">${clsName}</span>`;
            div.appendChild(row);
        });
    }

    window.exportAttendanceCSV = function() {
        const cid = document.getElementById('att-class-select').value;
        if(!cid) return showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "bg-yellow-600");

        const cls = dataState.classes.find(c=>c.id==cid);
        const students = dataState.students.filter(s=>s.classId==cid).sort((a,b)=>Number(a.no)-Number(b.no));
        const logs = dataState.attendance.filter(a=>a.classId==cid);
        const dates = [...new Set(logs.map(a=>a.date))].sort();

        let csv = "\uFEFFNo,ID,Name," + dates.join(",") + ",Present,Absent,Late,Percent\n";

        students.forEach((s, idx) => {
            let row = [s.no || (idx+1), s.code || '-', `"${s.name}"`];
            let p=0, a=0, l=0;
            dates.forEach(d => {
                const log = logs.find(x => x.studentId == s.id && x.date == d);
                const st = log ? log.status : '-';
                row.push(st);
                if(st=='‡∏°‡∏≤') p++; if(st=='‡∏Ç‡∏≤‡∏î') a++; if(st=='‡∏•‡∏≤') l++;
            });
            const total = p+a+l;
            const percent = total > 0 ? Math.round((p/total)*100) : 0;
            row.push(p, a, l, percent + '%');
            csv += row.join(",") + "\n";
        });

        const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csv);
        const link = document.createElement("a");
        link.href = encodedUri; link.download = `Attendance_${cls.name}_${getThaiDateISO()}.csv`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    };
    
    window.exportGradeCSV = function() {
        const cid = document.getElementById('report-class').value;
        if(!cid) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
        
        const className = dataState.classes.find(c=>c.id==cid)?.name || "Unknown";
        const students = dataState.students.filter(s => s.classId == cid).sort((a,b)=>Number(a.no)-Number(b.no)); 
        const tasks = dataState.tasks.filter(t => t.classId == cid); 
        
        let csvContent = "\uFEFFNo,StudentID,Name,Chapter1,Chapter2,Chapter3,Chapter4,Chapter5,Chapter6,Midterm,Final,Total,Grade\n";
        
        students.forEach((s, idx) => {
             const { chapScores, midterm, final, total } = calculateScores(s.id, cid, tasks);
             const grade = calGrade(total);
             
             let row = [s.no || (idx + 1), `"${s.code || '-'}"`, `"${s.name}"`, ...chapScores, midterm, final, total, grade];
             csvContent += row.join(",") + "\n";
        });
        
        const link = document.createElement("a");
        link.href = encodeURI("data:text/csv;charset=utf-8," + csvContent);
        link.download = `GradeReport_${className}_${getThaiDateISO()}.csv`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    };

    function renderIncomingSubmissions() {
        const container = document.getElementById('incoming-list'); container.innerHTML = '';
        let pending = dataState.submissions.filter(sub => !dataState.scores.some(sc => sc.taskId == sub.taskId && sc.studentId == sub.studentId));
        pending.sort((a,b) => new Date(b.timestampISO) - new Date(a.timestampISO));

        if(pending.length === 0) { container.innerHTML = '<div class="text-center text-white/50 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div>'; return; }

        pending.forEach(sub => {
            const task = dataState.tasks.find(t => t.id == sub.taskId);
            const student = dataState.students.find(s => s.id == sub.studentId);
            if(!task || !student) return;
            
            const div = document.createElement('div');
            div.className = "bg-white/5 p-4 rounded-xl border border-white/10 flex flex-col gap-3";
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <span class="bg-blue-500/20 text-blue-300 text-[10px] px-2 py-0.5 rounded font-bold">${dataState.classes.find(c=>c.id==student.classId)?.name || '-'}</span>
                        <h4 class="font-bold text-white text-sm mt-1">${task.name}</h4>
                        <p class="text-xs text-yellow-400">${student.name} (No.${student.no})</p>
                    </div>
                    <a href="${sub.link}" target="_blank" class="text-blue-400 text-xs hover:underline"><i class="fa-solid fa-link"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</a>
                </div>
                ${sub.comment ? `<div class="bg-black/20 p-2 rounded text-xs text-white/70 border-l-2 border-blue-500">"${sub.comment}"</div>` : ''}
                <div class="flex gap-2 items-center">
                    <input id="grade-${sub.taskId}-${sub.studentId}" type="number" class="glass-input rounded px-2 py-1 text-xs w-20 text-center" placeholder="Max ${task.maxScore}">
                    <button onclick="submitGrade('${sub.studentId}', '${sub.taskId}', ${task.maxScore})" class="btn-blue px-3 py-1 rounded text-xs font-bold">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                    <button onclick="returnWork('${sub.studentId}', '${sub.taskId}')" class="btn-yellow px-3 py-1 rounded text-xs">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    window.submitGrade = function(sid, tid, max) {
        const val = document.getElementById(`grade-${tid}-${sid}`).value;
        if(val === '') return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
        if(Number(val) > Number(max)) return alert("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏°");
        saveAndRefresh({ action:'addScore', studentId: sid, taskId: tid, score: val });
    };

    window.returnWork = function(sid, tid) {
        const reason = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ):");
        if(reason) { saveAndRefresh({ action:'returnForRevision', studentId: sid, taskId: tid, comment: reason }); }
    };
    
    // Function to close modal and refocus scanner
    window.closeScoreModal = function() {
        document.getElementById('score-modal').classList.add('hidden');
        // Re-focus scanner after short delay
        setTimeout(() => {
            const scanInput = document.getElementById('scan-score-input');
            if(scanInput) scanInput.focus();
        }, 300);
    }

    function initEventListeners() {
        document.getElementById('admin-login-form').onsubmit = async (e) => { 
            e.preventDefault(); 
            const u=document.getElementById('admin-username').value, p=document.getElementById('admin-password').value; 
            const res = await saveAndRefresh({action:'login', username:u, password:p}); 
            if(res.status=='success'){ localStorage.setItem('wany_admin_session', res.token); showAdminPanel(); } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î"); 
        };
        document.getElementById('form-task').onsubmit = (e) => { 
            e.preventDefault(); 
            const classCbs = document.querySelectorAll('#task-class-checkboxes input:checked');
            const chapCbs = document.querySelectorAll('.chapter-checkbox:checked');
            if(classCbs.length===0) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á");
            const selectedChaps = Array.from(chapCbs).map(cb => cb.value);
            const cat = document.getElementById('task-category').value;
            if(cat === 'accum' && selectedChaps.length === 0) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");

            saveAndRefresh({ action: 'addTask', id: Date.now(), classIds: Array.from(classCbs).map(c=>c.value), subjectId: document.getElementById('task-subject-filter').value, category: cat, chapter: selectedChaps, name: document.getElementById('task-name').value, maxScore: document.getElementById('task-max').value, dueDateISO: getThaiDateISO() });
            e.target.reset(); document.querySelectorAll('.chapter-checkbox').forEach(c => c.checked = false); alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
        };
        
        document.getElementById('form-schedule').onsubmit = (e) => {
            e.preventDefault();
            saveAndRefresh({ action:'addSchedule', id:Date.now(), day: document.getElementById('sch-day').value, period: document.getElementById('sch-period').value, classId: document.getElementById('sch-class').value });
        };

        // STUDENT SUBMIT FORM LISTENER (with Debounce)
        document.getElementById('form-submit-work').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit-final');
            const originalText = btn.innerHTML;
            
            // Disable Button
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

            const tid = document.getElementById('submit-task-id').value;
            const sid = document.getElementById('submit-student-id').value;
            const link = document.getElementById('submit-link-input').value;
            const comment = document.getElementById('submit-comment-input').value;

            // Collect Group IDs
            const checkboxes = document.querySelectorAll('.friend-checkbox:checked');
            let allStudentIds = [sid]; 
            checkboxes.forEach(cb => allStudentIds.push(cb.value));

            try {
                await saveAndRefresh({ action: 'submitTask', taskId: tid, studentIds: allStudentIds, link: link, comment: comment });
                document.getElementById('submit-modal').classList.add('hidden');
                showToast(allStudentIds.length > 1 ? `‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° (${allStudentIds.length} ‡∏Ñ‡∏ô) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢` : "‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                setTimeout(handleStudentLogin, 100); 
            } catch(err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô");
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // Friend Search Listener
        document.getElementById('friend-search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.friend-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'flex' : 'none';
            });
        });

        document.getElementById('task-category').onchange = (e) => { e.target.value === 'accum' ? document.getElementById('chapter-wrapper').classList.remove('hidden') : document.getElementById('chapter-wrapper').classList.add('hidden'); }
        document.getElementById('form-subject').onsubmit = (e) => { e.preventDefault(); saveAndRefresh({ action:'addSubject', id:Date.now(), name:document.getElementById('subject-name').value }); e.target.reset(); };
        document.getElementById('form-class').onsubmit = (e) => { e.preventDefault(); saveAndRefresh({ action:'addClass', id:Date.now(), name:document.getElementById('class-name').value, subjectId:document.getElementById('class-subject-ref').value }); e.target.reset(); };
        document.getElementById('form-student').onsubmit = (e) => { e.preventDefault(); saveAndRefresh({ action: 'addStudent', id: Date.now(), classId: document.getElementById('student-class').value, no: document.getElementById('student-no').value, code: document.getElementById('student-id').value, name: document.getElementById('student-name').value }); e.target.reset(); };
        
        // NEW: Report Filters
        document.getElementById('report-subject').onchange = updateReportClassDropdown;
        document.getElementById('report-class').onchange = renderGradeReport;

        document.getElementById('scan-class-select').onchange = () => { updateScanTaskDropdown(); renderScoreRoster(); };
        document.getElementById('scan-task-select').onchange = renderScoreRoster;
        document.getElementById('att-class-select').onchange = renderAttRoster;
        document.getElementById('att-date-input').onchange = renderAttRoster;
        document.getElementById('btn-modal-save').onclick = () => {
            const val = document.getElementById('modal-score-input').value;
            const {s,t} = pendingScore;
            if(Number(val) > Number(t.maxScore)) return alert("‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°");
            saveAndRefresh({action:'addScore', studentId:s.id, taskId:t.id, score:val});
            closeScoreModal(); // Use new close function
            showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
        };
        document.getElementById('form-material').onsubmit = (e) => { e.preventDefault(); saveAndRefresh({ action: 'addMaterial', id: Date.now(), subjectId: document.getElementById('mat-subject').value, title: document.getElementById('mat-title').value, type: 'link', link: document.getElementById('mat-link').value }); e.target.reset(); }
        
        // --- 1. Modal Score Input (Enter -> Save) ---
        document.getElementById('modal-score-input').onkeydown = (e) => {
            if(e.key === 'Enter') document.getElementById('btn-modal-save').click();
        };

        // --- 2. Main Scan Input (Enter -> Check Mode) ---
        document.getElementById('scan-score-input').onkeydown = (e) => {
            if(e.key === 'Enter') {
                const val = e.target.value.trim();
                const cid = document.getElementById('scan-class-select').value;
                if(!cid) return;
                const s = dataState.students.find(st => (st.code == val || st.no == val) && st.classId == cid);
                
                if(s) {
                    const tid = document.getElementById('scan-task-select').value;
                    const t = dataState.tasks.find(x=>x.id==tid);
                    if(t) {
                        // FIX: CHECK SCORE MODE
                        if(scoreMode !== 'manual') {
                            if(Number(scoreMode) > Number(t.maxScore)) {
                                alert("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ!");
                            } else {
                                saveAndRefresh({action:'addScore', studentId:s.id, taskId:t.id, score:scoreMode});
                                showToast(`${s.name} : ${scoreMode} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, "bg-green-600");
                            }
                        } else {
                            pendingScore = { s, t };
                            document.getElementById('score-modal').classList.remove('hidden');
                            document.getElementById('modal-task-name').textContent = t.name;
                            document.getElementById('modal-student-name').textContent = s.name;
                            document.getElementById('modal-max-score').textContent = t.maxScore;
                            const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                            document.getElementById('modal-score-input').value = sc ? sc.score : '';
                            setTimeout(() => document.getElementById('modal-score-input').focus(), 100);
                        }
                        e.target.value = ''; // Clear for next student
                    }
                } else {
                    showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "bg-red-600");
                    e.target.value = '';
                }
            }
        };

        // --- 3. Attendance Scanner Logic ---
        document.getElementById('att-scan-input').onkeydown = (e) => {
            if(e.key === 'Enter') {
                const val = e.target.value.trim();
                const cid = document.getElementById('att-class-select').value;
                const date = document.getElementById('att-date-input').value;
                const mode = attMode || '‡∏°‡∏≤'; // Default to Present if none selected

                if(!cid) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô"); e.target.value=''; return; }

                const s = dataState.students.find(st => (st.code == val || st.no == val) && st.classId == cid);
                if(s) {
                    saveAndRefresh({ action:'addAttendance', studentId:s.id, classId:cid, date:date, status:mode });
                    showToast(`${s.name} : ${mode}`, "bg-green-600");
                } else {
                    showToast(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™: ${val}`, "bg-red-600");
                }
                e.target.value = '';
            }
        };
        // ---------------------------------------------
        
        // Student Login Enter
        document.getElementById('student-login-id').onkeydown = (e) => { if(e.key === 'Enter') handleStudentLogin(); };
    }

    function getThaiDateISO() { const d=new Date(); const u=d.getTime()+(d.getTimezoneOffset()*60000); const b=new Date(u+(7*3600000)); return b.toISOString().slice(0,10); }
    
    // Improved Thai Date Formatter
    function formatThaiDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "-"; 
        
        return new Intl.DateTimeFormat('th-TH', {
            day: 'numeric',
            month: 'short', // ‡∏°.‡∏Ñ., ‡∏Å.‡∏û.
            year: '2-digit' // 67, 68
        }).format(date);
    }
    
    function calculateScores(studentId, classId, tasks) {
        let chapData = Array(6).fill().map(() => ({ earn: 0, max: 0 }));
        let midterm = 0, final = 0, totalScore = 0;
        tasks.forEach(t => {
            const scoreLog = dataState.scores.find(x => x.studentId == studentId && x.taskId == t.id);
            const score = scoreLog ? Number(scoreLog.score) : 0;
            const max = Number(t.maxScore);
            if (t.category === 'accum') {
                const chapters = t.chapter ? t.chapter.toString().split(',') : [];
                if(chapters.length > 0) {
                    const splitMax = max / chapters.length, splitScore = score / chapters.length;
                    chapters.forEach(c => { const idx = parseInt(c) - 1; if(idx >= 0 && idx < 6) { chapData[idx].max += splitMax; chapData[idx].earn += splitScore; } });
                }
            } else if (t.category === 'midterm') midterm += score;
            else if (t.category === 'final') final += score;
            if(t.category === 'special') totalScore += score;
        });
        const chapScores = chapData.map(d => d.max > 0 ? Math.round((d.earn / d.max) * 10) : 0);
        totalScore += chapScores.reduce((a,b)=>a+b,0) + midterm + final;
        return { chapScores, midterm, final, total: totalScore };
    }
    
    function calGrade(s) { if(s>=80)return 4; if(s>=75)return 3.5; if(s>=70)return 3; if(s>=65)return 2.5; if(s>=60)return 2; if(s>=55)return 1.5; if(s>=50)return 1; return 0; }
    function showToast(m,c){ 
        const t=document.getElementById('toast-notification'); document.getElementById('toast-message').textContent=m; 
        t.className=`fixed bottom-10 left-1/2 -translate-x-1/2 bg-gradient-to-r from-green-600 to-teal-600 text-white px-8 py-4 rounded-full shadow-2xl z-50 flex items-center gap-3 translate-y-20 opacity-0 font-bold border border-green-400/50 toast-show`; 
        setTimeout(()=>t.classList.remove('toast-show'),3000); 
    }
    function updateInboxBadge() {
        let count = 0;
        dataState.submissions.forEach(sub => { if(!dataState.scores.some(sc => sc.taskId == sub.taskId && sc.studentId == sub.studentId)) count++; });
        const badge = document.getElementById('badge-homework'); count > 0 ? (badge.classList.remove('hidden'), badge.textContent = count > 99 ? '99+' : count) : badge.classList.add('hidden');
    }
    function switchMainTab(t) { 
        document.getElementById('section-admin').classList.add('hidden'); document.getElementById('section-student').classList.add('hidden'); document.getElementById(`section-${t}`).classList.remove('hidden'); 
        const btnA = document.getElementById('tab-btn-admin'), btnS = document.getElementById('tab-btn-student');
        if(t=='admin'){ btnA.className="px-6 py-2 rounded-full text-sm font-bold bg-white text-blue-900 shadow-lg transition-all"; btnS.className="px-6 py-2 rounded-full text-sm font-bold text-white/50 hover:text-white transition-all"; }
        else { btnS.className="px-6 py-2 rounded-full text-sm font-bold bg-white text-blue-900 shadow-lg transition-all"; btnA.className="px-6 py-2 rounded-full text-sm font-bold text-white/50 hover:text-white transition-all"; }
    }
    function switchAdminSubTab(t) { 
        document.querySelectorAll('.admin-panel').forEach(p=>p.classList.add('hidden')); document.getElementById(`admin-panel-${t}`).classList.remove('hidden'); 
        document.querySelectorAll('.menu-btn').forEach(b => { b.className="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"; });
        const activeBtn = document.getElementById(`menu-${t}`); if(activeBtn) activeBtn.className="menu-btn btn-blue rounded-2xl py-3 font-bold shadow-lg text-white";
        refreshUI();
    }
    function refreshDropdowns() {
        const setOpts = (id, list) => { const el=document.getElementById(id); if(!el) return; const cur=el.value; el.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>'; list.forEach(i=>{ const o=document.createElement('option'); o.value=i.id; o.textContent=i.name; el.appendChild(o); }); el.value=cur; };
        setOpts('class-subject-ref', dataState.subjects); setOpts('student-class', dataState.classes); setOpts('scan-class-select', dataState.classes); setOpts('task-subject-filter', dataState.subjects); setOpts('att-class-select', dataState.classes); setOpts('mat-subject', dataState.subjects); setOpts('sch-class', dataState.classes);
        // NEW: Load Subjects for Report
        setOpts('report-subject', dataState.subjects);
    }
    
    function updateReportClassDropdown() {
        const subId = document.getElementById('report-subject').value;
        const classSelect = document.getElementById('report-class');
        classSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>';
        document.getElementById('report-table-body').innerHTML = ''; // Clear table

        if(!subId) return;

        // Filter classes for selected subject
        const filteredClasses = dataState.classes.filter(c => c.subjectId == subId);
        filteredClasses.forEach(c => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = c.name;
            classSelect.appendChild(o);
        });
    }

    function updateScanTaskDropdown() {
        const cid = document.getElementById('scan-class-select').value; const el = document.getElementById('scan-task-select'); 
        const currentTaskId = el.value; // Store value
        el.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô --</option>';
        dataState.tasks.filter(t => t.classId == cid).reverse().forEach(t => { const o=document.createElement('option'); o.value=t.id; o.textContent=`${t.name} (Max ${t.maxScore})`; el.appendChild(o); });
        if(currentTaskId) el.value = currentTaskId; // Restore value
    }
    function renderTaskClassCheckboxes() {
        const subId = document.getElementById('task-subject-filter').value; const div = document.getElementById('task-class-checkboxes'); div.innerHTML='';
        dataState.classes.filter(c=>c.subjectId==subId).forEach(c => { const lbl = document.createElement('label'); lbl.className="flex items-center gap-2 p-2 rounded hover:bg-white/10 cursor-pointer"; lbl.innerHTML=`<input type="checkbox" value="${c.id}" class="accent-yellow-500 w-4 h-4 rounded"><span class="text-xs text-white/80">${c.name}</span>`; div.appendChild(lbl); });
    }
    
    function handleAdminLogout() { 
        if(confirm("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) { 
            localStorage.removeItem('wany_admin_session'); 
            localStorage.removeItem('wany_data_backup'); // Clear data to force fresh sync
            location.reload(); 
        } 
    }

    // --- VISUAL HIGHLIGHTS (SCORE) ---
    function renderScoreButtons() { const c = document.getElementById('score-buttons-container'); if(!c) return; c.innerHTML=''; [5,6,7,8,9,10].forEach(i => { const b = document.createElement('button'); b.textContent=i; b.className="btn-score py-2 rounded-lg border border-white/20 bg-white/5 text-white hover:bg-white/10"; b.onclick=()=>setScoreMode(i); c.appendChild(b); }); }
    function setScoreMode(m) { 
        scoreMode = m; 
        document.querySelectorAll('.btn-score').forEach(b => {
            b.classList.remove('btn-score-active');
            if(b.textContent == m) b.classList.add('btn-score-active');
        }); 
        if(m=='manual') document.getElementById('btn-score-manual').classList.add('btn-score-active');
        else document.getElementById('btn-score-manual').classList.remove('btn-score-active');
        document.getElementById('scan-score-input').focus(); 
    }
    
    function renderScoreRoster() { 
        const cid = document.getElementById('scan-class-select').value, taskId = document.getElementById('scan-task-select').value, div = document.getElementById('score-roster-grid'); div.innerHTML = ''; if(!cid || !taskId) return; 
        dataState.students.filter(s => s.classId == cid).sort((a,b)=>Number(a.no)-Number(b.no)).forEach(s => { 
            const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == taskId), val = sc ? sc.score : '-'; 
            const el = document.createElement('div'); el.className = `status-box ${sc ? 'status-done' : 'status-none'} p-2 flex flex-col items-center justify-center cursor-pointer`; 
            el.onclick = () => { pendingScore = { s, t: dataState.tasks.find(t=>t.id==taskId) }; document.getElementById('score-modal').classList.remove('hidden'); document.getElementById('modal-task-name').textContent = pendingScore.t.name; document.getElementById('modal-student-name').textContent = s.name; document.getElementById('modal-max-score').textContent = pendingScore.t.maxScore; document.getElementById('modal-score-input').value = val == '-' ? '' : val; setTimeout(() => document.getElementById('modal-score-input').focus(), 100); };
            el.innerHTML = `<div class="text-xs opacity-70">No. ${s.no}</div><div class="font-bold text-center text-xs truncate w-full">${s.name}</div><div class="text-xl font-bold mt-1">${val}</div>`; div.appendChild(el); 
        }); 
    }
    
    // --- VISUAL HIGHLIGHTS (ATTENDANCE) ---
    function renderAttRoster() {
        const cid = document.getElementById('att-class-select').value, div = document.getElementById('att-roster-grid'), date = document.getElementById('att-date-input').value; div.innerHTML = ''; if(!cid) return;
        
        let p=0, l=0, a=0;
        
        dataState.students.filter(s => s.classId == cid).sort((a,b)=>Number(a.no)-Number(b.no)).forEach(s => {
             // Safe date compare: Match exact string OR Match substring (YYYY-MM-DD)
             const log = dataState.attendance.find(a => a.studentId==s.id && (a.date == date || (a.date && a.date.substring(0,10) == date)));
             const st = log ? log.status : 'none';
             if(st=='‡∏°‡∏≤') p++; if(st=='‡∏•‡∏≤') l++; if(st=='‡∏Ç‡∏≤‡∏î') a++;
             
             const c = st=='‡∏°‡∏≤'?'status-done':(st=='‡∏•‡∏≤'?'bg-yellow-500/20 border-yellow-500 text-yellow-500':(st=='‡∏Ç‡∏≤‡∏î'?'bg-red-500/20 border-red-500 text-red-500':'status-none'));
             const el = document.createElement('div'); el.className = `status-box ${c} p-3 flex flex-col items-center justify-center cursor-pointer border`;
             el.onclick = () => { if(attMode) saveAndRefresh({action:'addAttendance', studentId:s.id, classId:cid, date:date, status:attMode}); };
             el.innerHTML = `<div class="text-xs opacity-70">No. ${s.no}</div><div class="font-bold text-center text-sm">${s.name}</div><div class="text-[10px] mt-1">${st}</div>`; div.appendChild(el);
        });
        
        // Update Stats
        document.getElementById('stat-present').textContent = p;
        document.getElementById('stat-leave').textContent = l;
        document.getElementById('stat-absent').textContent = a;
    }
    
    // --- Auto Focus Scanner ---
    function setAttMode(m) { 
        attMode = m; 
        document.getElementById('btn-att-present').classList.remove('btn-att-active-present');
        document.getElementById('btn-att-leave').classList.remove('btn-att-active-leave');
        document.getElementById('btn-att-absent').classList.remove('btn-att-active-absent');
        
        if(m=='‡∏°‡∏≤') document.getElementById('btn-att-present').classList.add('btn-att-active-present');
        if(m=='‡∏•‡∏≤') document.getElementById('btn-att-leave').classList.add('btn-att-active-leave');
        if(m=='‡∏Ç‡∏≤‡∏î') document.getElementById('btn-att-absent').classList.add('btn-att-active-absent');

        const scanInput = document.getElementById('att-scan-input');
        if(scanInput) scanInput.focus();
    }
    
    function renderGradeReport() { 
        const cid = document.getElementById('report-class').value, tbody = document.getElementById('report-table-body'); tbody.innerHTML = ''; if(!cid) return; 
        const tasks = dataState.tasks.filter(t => t.classId == cid);
        dataState.students.filter(s => s.classId == cid).sort((a,b)=>Number(a.no)-Number(b.no)).forEach((s, idx) => { 
            const { chapScores, midterm, final, total } = calculateScores(s.id, cid, tasks), grade = calGrade(total);
            const tr = document.createElement('tr'); tr.className = "hover:bg-white/5 transition-colors"; 
            let html = `<td class="text-center text-white/50">${s.no||idx+1}</td><td class="px-2 py-3 text-white text-xs">${s.name}</td>`;
            chapScores.forEach(score => html += `<td class="text-center text-yellow-400 font-mono">${score}</td>`);
            html += `<td class="text-center text-blue-400 font-bold">${midterm}</td><td class="text-center text-red-400 font-bold">${final}</td><td class="text-center font-bold text-white bg-white/10">${total}</td><td class="text-center text-green-400 font-bold text-lg">${grade}</td>`;
            tr.innerHTML = html; tbody.appendChild(tr); 
        }); 
    }
    
    function printOfficialReport() {
        const cid = document.getElementById('report-class').value; 
        if(!cid) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á");
        
        // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const tbody = document.getElementById('print-table-body'); 
        tbody.innerHTML = ""; 
        
        const className = dataState.classes.find(c=>c.id==cid)?.name || '-';
        document.getElementById('print-subtitle').textContent = `‡∏´‡πâ‡∏≠‡∏á ${className} ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 1/2567`;
        
        const tasks = dataState.tasks.filter(t => t.classId == cid);
        const students = dataState.students.filter(s => s.classId == cid).sort((a,b)=>Number(a.no)-Number(b.no));
        
        // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        students.forEach((s, idx) => { 
            const { chapScores, midterm, final, total } = calculateScores(s.id, cid, tasks);
            const tr = document.createElement('tr');
            tr.className = "print-row"; // Add class for print control
            
            let html = `<td>${s.no || idx+1}</td><td>${s.code || '-'}</td><td style="text-align:left;">${s.name}</td>`;
            chapScores.forEach(sc => html += `<td>${sc}</td>`);
            html += `<td>${midterm}</td><td>${final}</td><td>${total}</td><td>${calGrade(total)}</td>`;
            
            tr.innerHTML = html; 
            tbody.appendChild(tr);
        });
        
        // 3. ‡∏£‡∏≠ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
        setTimeout(() => {
            window.print();
        }, 500);
    }

    function renderAdminMaterials() {
        const div = document.getElementById('admin-mat-list'); div.innerHTML = '';
        dataState.materials.forEach(m => {
            const sub = dataState.subjects.find(s=>s.id == m.subjectId)?.name || '-';
            const el = document.createElement('div'); el.className = "bg-white/5 p-3 rounded-xl border border-white/10 flex justify-between";
            el.innerHTML = `<div><div class="text-xs text-yellow-400">${sub}</div><div class="font-bold text-sm text-white"><a href="${m.link}" target="_blank" class="hover:underline">${m.title}</a></div></div>`; div.appendChild(el);
        });
    }

    // --- STUDENT SIDE FUNCTIONS ---
    function handleStudentLogin() {
         if (!dataState.students || dataState.students.length === 0) { 
            alert("‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà"); setTimeout(syncData, 500); return; 
         }
         const code = document.getElementById('student-login-id').value.trim();
         let s = dataState.students.find(x => x.code == code); 
         if(!s) {
            const s_loose = dataState.students.find(x => Number(x.code) == Number(code));
            if (s_loose) { s = s_loose; } else { alert(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${code}`); return; }
         }

         document.getElementById('student-login-wrapper').classList.add('hidden'); 
         document.getElementById('student-dashboard').classList.remove('hidden');
         
         document.getElementById('std-dash-name').textContent = s.name;
         const cName = dataState.classes.find(cls => cls.id == s.classId)?.name || '-';
         document.getElementById('std-dash-class').textContent = "Class: " + cName;
         
         renderStudentDashboard(s);
    }

    function renderStudentDashboard(s) {
        const container = document.getElementById('std-subjects-container');
        container.innerHTML = '';
        
        const myTasks = dataState.tasks.filter(t => t.classId == s.classId);
        const subjectsFound = [...new Set(myTasks.map(t => t.subjectId))];
        const today = getThaiDateISO();

        subjectsFound.forEach(subId => {
            const subName = dataState.subjects.find(sub => sub.id == subId)?.name || '‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)';
            const subjectTasks = myTasks.filter(t => t.subjectId == subId);
            
            // --- Grade Calc ---
            let chapScores = [0,0,0,0,0,0];
            for(let i=1; i<=6; i++) {
                const cTasks = subjectTasks.filter(t => t.category === 'accum' && t.chapter == i);
                let earn=0, max=0;
                cTasks.forEach(t => { 
                    const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id); 
                    earn += sc ? Number(sc.score) : 0; 
                    max += Number(t.maxScore); 
                });
                chapScores[i-1] = max > 0 ? Math.round((earn/max)*10) : 0;
            }
            const getSum = (cat) => { let sum = 0; subjectTasks.filter(t => t.category === cat).forEach(t => { const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id); sum += sc ? Number(sc.score) : 0; }); return sum; };
            const mid = getSum('midterm'); 
            const final = getSum('final'); 
            const total = chapScores.reduce((a,b)=>a+b, 0) + mid + final; 
            const grade = calGrade(total);

            // --- Materials ---
            const subMaterials = dataState.materials ? dataState.materials.filter(m => m.subjectId == subId) : [];
            let materialHtml = '';
            if(subMaterials.length > 0) {
                materialHtml = `<div class="mt-4 pt-4 border-t border-white/10"><h4 class="text-xs text-white/50 mb-2 font-bold"><i class="fa-solid fa-book-open mr-1"></i> ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4><div class="flex flex-col gap-2">`;
                subMaterials.forEach(m => {
                     materialHtml += `<a href="${m.link}" target="_blank" class="flex items-center gap-3 bg-white/5 hover:bg-white/10 p-2 rounded-xl border border-white/10 transition-all"><div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center border border-white/10"><i class="fa-solid fa-link text-blue-400"></i></div><div class="flex-1 min-w-0"><div class="text-xs font-bold text-white truncate">${m.title}</div><div class="text-[10px] text-white/50 truncate">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</div></div></a>`;
                });
                materialHtml += `</div></div>`;
            }

            // --- Card HTML ---
            const card = document.createElement('div');
            card.className = "glass-ios p-5 rounded-3xl border border-white/10 relative overflow-hidden";
            
            let html = `<h3 class="font-bold text-lg text-white mb-3 border-l-4 border-yellow-500 pl-3 flex justify-between items-center">${subName} <span class="text-sm bg-white/10 px-2 py-1 rounded-lg font-normal text-white/60">‡πÄ‡∏Å‡∏£‡∏î ${grade}</span></h3>`;
            
            // Score Table
            html += `<div class="overflow-x-auto mb-4 bg-black/20 rounded-xl border border-white/5"><table class="w-full text-sm text-center text-white/80"><thead class="bg-white/5 text-xs text-white/50"><tr><th class="p-2">C1</th><th class="p-2">C2</th><th class="p-2">C3</th><th class="p-2">C4</th><th class="p-2">C5</th><th class="p-2">C6</th><th class="p-2 text-blue-400">Mid</th><th class="p-2 text-red-400">Final</th><th class="p-2 text-white bg-white/5">Total</th></tr></thead><tbody><tr>${chapScores.map(c=>`<td class="p-2 font-mono text-yellow-400">${c}</td>`).join('')}<td class="p-2 text-blue-300 font-bold">${mid}</td><td class="p-2 text-red-300 font-bold">${final}</td><td class="p-2 text-white font-bold bg-white/10">${total}</td></tr></tbody></table></div>`;
            
            // Task Grid
            html += `<div class="mt-2"><h4 class="text-xs text-white/50 mb-2 font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h4><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 max-h-60 overflow-y-auto pr-1">`;
            
            subjectTasks.forEach(t => {
                const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                const submission = dataState.submissions.find(x => x.studentId == s.id && x.taskId == t.id);
                const returned = dataState.returns ? dataState.returns.find(x => x.studentId == s.id && x.taskId == t.id) : null;
                
                let statusClass = "", statusText = "", icon = "", actionBtn = "";

                if(returned) { 
                    statusClass = "bg-yellow-500/10 border-yellow-500 text-yellow-500 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all";
                    statusText = "‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; icon = `<i class="fa-solid fa-rotate-left mb-1"></i>`;
                    actionBtn = `<button onclick="openSubmitModal('${t.id}', '${s.id}', '${t.name}')" class="mt-1 bg-yellow-600 hover:bg-yellow-500 text-white text-[10px] px-2 py-1 rounded w-full">‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà</button>`;
                }
                else if(sc) { 
                    statusClass = "bg-green-500/10 border-green-500 text-green-400 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all";
                    statusText = `${sc.score}`; icon = `<i class="fa-solid fa-check-circle mb-1"></i>`;
                }
                else if (submission) {
                    statusClass = "bg-blue-500/10 border-blue-500 text-blue-400 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all";
                    statusText = "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à"; icon = `<i class="fa-solid fa-hourglass-half mb-1"></i>`;
                }
                else if(t.dueDateISO < today) { 
                    statusClass = "bg-red-500/10 border-red-500 text-red-400 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all";
                    statusText = "‡∏Ç‡∏≤‡∏î‡∏™‡πà‡∏á"; icon = `<i class="fa-solid fa-circle-exclamation mb-1"></i>`; 
                    actionBtn = `<button onclick="openSubmitModal('${t.id}', '${s.id}', '${t.name}')" class="mt-1 bg-red-700 hover:bg-red-600 text-white text-[10px] px-2 py-1 rounded w-full">‡∏™‡πà‡∏á(‡∏ä‡πâ‡∏≤)</button>`;
                }
                else { 
                    statusClass = "bg-white/5 border-white/20 text-white/50 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all";
                    statusText = "‡∏£‡∏≠‡∏™‡πà‡∏á"; icon = `<i class="fa-regular fa-clock mb-1"></i>`; 
                    actionBtn = `<button onclick="openSubmitModal('${t.id}', '${s.id}', '${t.name}')" class="mt-1 bg-white/10 hover:bg-white/20 text-white text-[10px] px-2 py-1 rounded w-full">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>`;
                }

                html += `<div class="${statusClass}"><div class="text-[10px] text-white/30 absolute top-2 right-2">${t.category}</div><div class="text-lg mt-1">${icon}</div><div class="text-xs font-bold truncate w-full px-1 mb-1">${t.name}</div><div class="text-sm font-bold bg-black/20 px-2 rounded mt-1">${statusText}</div>${actionBtn}</div>`;
            });
            html += `</div></div>`;
            html += materialHtml;
            card.innerHTML = html; 
            container.appendChild(card);
        });

        // Attendance History Table
        const ab = document.getElementById('std-att-body'); ab.innerHTML = '';
        const atts = dataState.attendance.filter(a => a.studentId == s.id).sort((a,b) => b.date.localeCompare(a.date));
        atts.forEach(a => { 
            const c = a.status == '‡∏°‡∏≤' ? 'text-green-400' : (a.status == '‡∏•‡∏≤' ? 'text-yellow-400' : 'text-red-400'); 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `<td class="px-3 py-2 text-white/50 font-mono text-xs">${formatThaiDate(a.date)}</td><td class="px-3 py-2 text-center font-bold ${c} text-xs">${a.status}</td>`; 
            ab.appendChild(tr); 
        });
    }

    function openSubmitModal(tid, sid, tname) {
        document.getElementById('submit-task-id').value = tid;
        document.getElementById('submit-student-id').value = sid;
        document.getElementById('submit-modal-title').textContent = "‡∏á‡∏≤‡∏ô: " + tname;
        document.getElementById('submit-link-input').value = "";
        document.getElementById('submit-comment-input').value = ""; 
        document.getElementById('friend-search').value = ""; // Reset search

        const container = document.getElementById('friend-selector-container'); container.innerHTML = '';
        const currentStudent = dataState.students.find(s => s.id == sid);
        if(currentStudent) {
            const friends = dataState.students.filter(s => s.classId == currentStudent.classId && s.id != sid).sort((a,b) => Number(a.no) - Number(b.no));
            if(friends.length === 0) container.innerHTML = '<div class="text-xs text-white/30 text-center">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô -</div>';
            friends.forEach(f => {
                const div = document.createElement('div');
                div.className = "friend-item flex items-center gap-2 bg-black/20 p-2 rounded hover:bg-white/5 cursor-pointer border border-transparent hover:border-blue-500/50";
                div.innerHTML = `<input type="checkbox" id="friend-${f.id}" value="${f.id}" class="accent-blue-500 w-4 h-4 rounded cursor-pointer friend-checkbox"><label for="friend-${f.id}" class="text-xs text-white/70 cursor-pointer select-none flex-1"><span class="font-bold text-white mr-1">${f.no}.</span> ${f.name}</label>`;
                container.appendChild(div);
            });
        }
        document.getElementById('submit-modal').classList.remove('hidden');
    }

    function logoutStudent() { document.getElementById('student-dashboard').classList.add('hidden'); document.getElementById('student-login-wrapper').classList.remove('hidden'); document.getElementById('student-login-id').value = ''; }
 </script>
 </body>
</html>
